<!DOCTYPE html>
<html>
<head>
  <script type="application/x-javascript;version=1.8" src="framework.js"></script>
  <script type="application/x-javascript;version=1.8" src="chrome://adblockplus/content/filterClasses.js"></script>
  <script type="application/x-javascript;version=1.8" src="chrome://adblockplus/content/matcher.js"></script>

  <script type="application/x-javascript;version=1.8">
    function tests()
    {
      let matcher = new Matcher();
      function compareShortcuts(text, expected)
      {
        expected.push(null);

        let filter = Filter.fromText(text);
        let result = [];
        for each (let shortcut in expected)
        {
          result.push(matcher.findShortcut(filter.text));
          if (shortcut)
            matcher.add(Filter.fromText(shortcut));
        }

        writeResult("Shortcut candidates for " + text, result.join("\n"), expected.join("\n"));
        matcher.clear();
      }
      function checkMatch(filters, location, contentType, thirdParty, expected)
      {
        for each (let filter in filters)
          matcher.add(Filter.fromText(filter));

        let result = matcher.matchesAny(location, contentType, thirdParty);
        if (result)
          result = result.text;

        writeResult("match(" + location + ", " + contentType + ", " + (thirdParty ? "third-party" : "first-party") + ") with:\n" + filters.join("\n"), result, expected);
        matcher.clear();
      }
      function cacheCheck(location, contentType, thirdParty, expected)
      {
        let result = matcher.matchesAny(location, contentType, thirdParty);
        if (result)
          result = result.text;

        writeResult("match(" + location + ", " + contentType + ", " + (thirdParty ? "third-party" : "first-party") + ") with static filters", result, expected);
      }

      compareShortcuts("*", []);
      compareShortcuts("asdf", []);
      compareShortcuts("asdf1234", ["asdf1234"]);
      compareShortcuts("asdf12345", ["asdf1234", "sdf12345"]);
      compareShortcuts("asdf123456", ["sdf12345", "df123456", "asdf1234"]);
      compareShortcuts("asdf123456a", ["sdf12345", "df123456", "asdf1234", "f123456a"]);
      compareShortcuts("asdf123456as", ["df123456", "f123456a", "sdf12345", "123456as", "asdf1234"]);
      compareShortcuts("asdf*1234", []);
      compareShortcuts("asdf1234*5678", ["asdf1234"]);
      compareShortcuts("asdf12345*678", ["sdf12345", "asdf1234"]);
      compareShortcuts("asdf1234*d*qwer5678", ["asdf1234", "qwer5678"]);
      compareShortcuts("|asdf1234", ["asdf1234"]);
      compareShortcuts("asdf1234|", ["asdf1234"]);
      compareShortcuts("|asdf12345|", ["asdf1234", "sdf12345"]);
      compareShortcuts("asdf|1234", ["asdf|123", "sdf|1234"]);
      compareShortcuts("/foo/", []);
      compareShortcuts("/foobarbar/", []);
      compareShortcuts("*/foo/", []);
      compareShortcuts("*/foobarbar/", ["foobarba", "oobarbar", "/foobarb", "obarbar/"]);

      checkMatch([], "http://abc/def", "IMAGE", false, null);
      checkMatch(["abc"], "http://abc/def", "IMAGE", false, "abc");
      checkMatch(["abc", "ddd"], "http://abc/def", "IMAGE", false, "abc");
      checkMatch(["ddd", "abc"], "http://abc/def", "IMAGE", false, "abc");
      checkMatch(["ddd", "abd"], "http://abc/def", "IMAGE", false, null);
      checkMatch(["abc", "://abc/d"], "http://abc/def", "IMAGE", false, "://abc/d");
      checkMatch(["://abc/d", "abc"], "http://abc/def", "IMAGE", false, "://abc/d");
      checkMatch(["abc", "://abc/d", "asdf1234"], "http://abc/def", "IMAGE", false, "://abc/d");
      checkMatch(["foo*://abc/d", "foo*//abc/de", "://abc/de", "asdf1234"], "http://abc/def", "IMAGE", false, "://abc/de");
      checkMatch(["abc$third-party", "abc$~third-party", "ddd"], "http://abc/def", "IMAGE", false, "abc$~third-party");
      checkMatch(["abc$third-party", "abc$~third-party", "ddd"], "http://abc/def", "IMAGE", true, "abc$third-party");
      checkMatch(["//abc/def$third-party", "//abc/def$~third-party", "//abc_def"], "http://abc/def", "IMAGE", false, "//abc/def$~third-party");
      checkMatch(["//abc/def$third-party", "//abc/def$~third-party", "//abc_def"], "http://abc/def", "IMAGE", true, "//abc/def$third-party");
      checkMatch(["abc$third-party", "abc$~third-party", "//abc/def"], "http://abc/def", "IMAGE", true, "//abc/def");
      checkMatch(["//abc/def", "abc$third-party", "abc$~third-party"], "http://abc/def", "IMAGE", true, "//abc/def");
      checkMatch(["abc$third-party", "abc$~third-party", "//abc/def$third-party"], "http://abc/def", "IMAGE", true, "//abc/def$third-party");
      checkMatch(["abc$third-party", "abc$~third-party", "//abc/def$third-party"], "http://abc/def", "IMAGE", false, "abc$~third-party");
      checkMatch(["abc$third-party", "abc$~third-party", "//abc/def$~third-party"], "http://abc/def", "IMAGE", true, "abc$third-party");
      checkMatch(["abc$image", "abc$script", "abc$~image"], "http://abc/def", "IMAGE", false, "abc$image");
      checkMatch(["abc$image", "abc$script", "abc$~script"], "http://abc/def", "SCRIPT", false, "abc$script");
      checkMatch(["abc$image", "abc$script", "abc$~image"], "http://abc/def", "OTHER", false, "abc$~image");
      checkMatch(["//abc/def$image", "//abc/def$script", "//abc/def$~image"], "http://abc/def", "IMAGE", false, "//abc/def$image");
      checkMatch(["//abc/def$image", "//abc/def$script", "//abc/def$~script"], "http://abc/def", "SCRIPT", false, "//abc/def$script");
      checkMatch(["//abc/def$image", "//abc/def$script", "//abc/def$~image"], "http://abc/def", "OTHER", false, "//abc/def$~image");
      checkMatch(["abc$image", "abc$~image", "//abc/def"], "http://abc/def", "IMAGE", false, "//abc/def");
      checkMatch(["//abc/def", "abc$image", "abc$~image"], "http://abc/def", "IMAGE", false, "//abc/def");
      checkMatch(["abc$image", "abc$~image", "//abc/def$image"], "http://abc/def", "IMAGE", false, "//abc/def$image");
      checkMatch(["abc$image", "abc$~image", "//abc/def$script"], "http://abc/def", "IMAGE", false, "abc$image");

      // Testing whether result cache messes up results
      matcher.add(Filter.fromText("abc$image"));
      matcher.add(Filter.fromText("abc$script"));
      matcher.add(Filter.fromText("abc$~image,~script,~document"));
      matcher.add(Filter.fromText("cba$third-party"));
      matcher.add(Filter.fromText("cba$~third-party,~script"));
      matcher.add(Filter.fromText("http://def$image"));
      matcher.add(Filter.fromText("http://def$script"));
      matcher.add(Filter.fromText("http://def$~image,~script,~document"));
      matcher.add(Filter.fromText("http://fed$third-party"));
      matcher.add(Filter.fromText("http://fed$~third-party,~script"));
      cacheCheck("http://abc", "IMAGE", false, "abc$image");
      cacheCheck("http://abc", "SCRIPT", false, "abc$script");
      cacheCheck("http://abc", "OTHER", false, "abc$~image,~script,~document");
      cacheCheck("http://cba", "IMAGE", false, "cba$~third-party,~script");
      cacheCheck("http://cba", "IMAGE", true, "cba$third-party");
      cacheCheck("http://def", "IMAGE", false, "http://def$image");
      cacheCheck("http://def", "SCRIPT", false, "http://def$script");
      cacheCheck("http://def", "OTHER", false, "http://def$~image,~script,~document");
      cacheCheck("http://fed", "IMAGE", false, "http://fed$~third-party,~script");
      cacheCheck("http://fed", "IMAGE", true, "http://fed$third-party");
      cacheCheck("http://abc_cba", "DOCUMENT", false, "cba$~third-party,~script");
      cacheCheck("http://abc_cba", "DOCUMENT", true, "cba$third-party");
      cacheCheck("http://abc_cba", "SCRIPT", false, "abc$script");
      cacheCheck("http://def?http://fed", "DOCUMENT", false, "http://fed$~third-party,~script");
      cacheCheck("http://def?http://fed", "DOCUMENT", true, "http://fed$third-party");
      cacheCheck("http://def?http://fed", "SCRIPT", false, "http://def$script");
    }
  </script>
</head>
<body>
</body>
</html>